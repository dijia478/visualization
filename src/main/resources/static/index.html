<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <title>公众号：万户楼台</title>
    <script type="text/javascript" src="https://unpkg.com/@antv/g2plot@latest/dist/g2plot.min.js"></script>
    <script src="https://unpkg.com/@antv/s2@latest/dist/index.min.js"></script>

    <link href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/bootstrap/4.6.1/css/bootstrap.min.css" type="text/css" rel="stylesheet"/>
    <script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/3.6.0/jquery.min.js" type="application/javascript"></script>
    <script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/bootstrap/4.6.1/js/bootstrap.bundle.min.js" type="application/javascript"></script>
    <script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/lodash.js/4.17.21/lodash.min.js" type="application/javascript"></script>
    <link rel="stylesheet" type="text/css" href="input.css">
    <script>
        const {Line} = G2Plot;
        const {Bar} = G2Plot;
        const {TableSheet} = S2;
    </script>
</head>
<body>

<div>
    <div id="errorMsg"></div>

    <div class="bs-form">
        <form id="form1">
            <div class="form-group row">
                <label for="amount" class="col-sm-2 col-form-label">贷款金额</label>
                <div class="input-group mb-3 col-sm-10">
                    <input type="text" class="form-control" id="amount" name="amount" placeholder="例如：100" required>
                    <div class="input-group-append">
                        <span class="input-group-text">万元</span>
                    </div>
                </div>
            </div>
            <div class="form-group row">
                <label for="year" class="col-sm-2 col-form-label">贷款期限</label>
                <div class="input-group mb-3 col-sm-10">
                    <input type="text" class="form-control" id="year" name="year" placeholder="例如：30" required>
                    <div class="input-group-append">
                        <span class="input-group-text">年</span>
                    </div>
                </div>
            </div>
            <div class="form-group row">
                <label for="rate" class="col-sm-2 col-form-label">年利率</label>
                <div class="input-group mb-3  col-sm-10">
                    <input type="text" class="form-control" id="rate" name="rate" placeholder="例如：4.2" required>
                    <div class="input-group-append">
                        <span class="input-group-text">%</span>
                    </div>
                </div>
            </div>
            <fieldset class="form-group row">
                <legend class="col-form-label col-sm-2 float-sm-left pt-0">还款方式</legend>
                <div class="col-sm-10">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="type" id="type1" value="1" checked>
                        <label class="form-check-label" for="type1">等额本息</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="type" id="type2" value="2">
                        <label class="form-check-label" for="type2">等额本金</label>
                    </div>
                </div>
            </fieldset>
            <fieldset class="form-group row">
                <legend class="col-form-label col-sm-2 float-sm-left pt-0">提前还款</legend>
                <div class="col-sm-10">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="prepayment" id="prepayment1" value="0" checked>
                        <label class="form-check-label" for="prepayment1">否</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="prepayment" id="prepayment2" value="1">
                        <label class="form-check-label" for="prepayment2">是</label>
                    </div>
                </div>
            </fieldset>
            <button id="submit-btn" type="button" class="btn btn-primary btn-block">计算</button>
        </form>
    </div>


    <div id="container3"></div>
    <div class="empty"></div>
    <div id="container4"></div>
    <div class="empty"></div>
    <div id="container2"></div>
    <div class="empty"></div>
    <div id="container1"></div>
    <div class="empty"></div>
</div>
<script>
    validated();
    // 提交按钮点击事件
    $('#submit-btn').click(function (e) {
        $('#errorMsg').html("");
        $('#container1').html("");
        $('#container2').html("");
        $('#container3').html("");
        $('#container4').html("");

        // ajax提交
        $.ajax({
            method: 'POST',
            url: '/loanCalculator',
            dataType: 'json',
            contentType: 'application/json;charset=UTF-8',
            data: JSON.stringify({
                amount: $("#amount").val(),
                rate: $("#rate").val(),
                year: $("#year").val(),
                type: $('input[name="type"]:checked').val(),
                prepayment: $('input[name="prepayment"]:checked').val(),
            }),
        }).done(function (response) {
            if (response.code == 200) {
                // 数据提交成功后处理返回结果
                drawPicture3(response);
                drawPicture1(response);
                drawPicture2(response);
            } else if (response.code == 602) {
                // 数据提交失败后处理
                $('#errorMsg').html('<div class="alert alert-danger alert-dismissible fade show" role="alert"><strong>输入错误！</strong>'+response.data+'<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>').show();
            } else {
                $('#errorMsg').html('<div class="alert alert-danger alert-dismissible fade show" role="alert"><strong>请到万户楼台联系管理员！</strong>'+response.message+'<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>').show();
            }
        }).fail(function (xhr, status) {
            $('#errorMsg').html('<div class="alert alert-danger alert-dismissible fade show" role="alert"><strong>请到万户楼台联系管理员！</strong>'+status+'<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>').show();
        });
    });

    function drawPicture1(response) {
        let arr = [];
        let respData = response.data;
        let repayment = 0;
        for (let i = 0, n = respData.monthLoanList.length; i < n; i++) {
            let monthLoan = respData.monthLoanList[i];
            repayment += monthLoan.repayment;
            arr.push({
                month: monthLoan.month,
                repayment: monthLoan.repayment.toFixed(2),
                principal: monthLoan.principal.toFixed(2),
                interest: monthLoan.interest.toFixed(2),
                remainPrincipal: monthLoan.remainPrincipal.toFixed(2),
                remainInterest: monthLoan.remainInterest.toFixed(2),
                totalRepayment: monthLoan.totalRepayment.toFixed(2),
                // totalRepaymentAndRemainPrincipal: monthLoan.totalRepaymentAndRemainPrincipal.toFixed(2),
            });
        }
        let loanAmount = respData.loanAmount;
        arr.unshift({
            month: "总计",
            repayment: repayment.toFixed(2),
            principal: loanAmount.toFixed(2),
            interest: (repayment - loanAmount).toFixed(2),
        });

        const container = document.getElementById('container1');
        const s2DataConfig = {
            fields: {
                columns: ['month', 'repayment', 'principal', 'interest', 'remainPrincipal', 'remainInterest', 'totalRepayment'],
            },
            meta: [
                {
                    field: 'month',
                    name: '期数',
                },
                {
                    field: 'repayment',
                    name: '当月还款',
                },
                {
                    field: 'principal',
                    name: '其中本金',
                },
                {
                    field: 'interest',
                    name: '其中利息',
                },
                {
                    field: 'remainPrincipal',
                    name: '剩余本金',
                },
                {
                    field: 'remainInterest',
                    name: '剩余利息',
                },
                {
                    field: 'totalRepayment',
                    name: '累计还款',
                },
                // {
                //     field: 'totalRepaymentAndRemainPrincipal',
                //     name: '累计还款+剩余本金',
                // },
            ],
            data: arr,
        };

        const s2Options = {
            width: 600,
            height: 600,
        };
        const s2 = new TableSheet(container, s2DataConfig, s2Options);
        s2.render();

        const debounceRender = _.debounce((width, height) => {
            s2.changeSheetSize(width, height)
            s2.render(false) // 不重新加载数据
        }, 200)

        const resizeObserver = new ResizeObserver(([entry] = []) => {
            const [size] = entry.borderBoxSize || [];
            debounceRender(size.inlineSize, size.blockSize)
        });

        resizeObserver.observe(container);
    }

    function drawPicture2(response) {
        let arr = [];
        let data = response.data;
        for (let i = 0, n = data.monthLoanList.length; i < n; i++) {
            let monthLoan = data.monthLoanList[i];
            arr.push({
                months: monthLoan.month + "期",
                value: monthLoan.principal,
                type: "本金",
            });
            arr.push({
                months: monthLoan.month + "期",
                value: monthLoan.interest,
                type: "利息",
            });
        }

        const stackedBarPlot = new Bar('container2', {
            data: arr,
            isStack: true,
            xField: 'value',
            yField: 'months',
            seriesField: 'type',
            label: {
                // 可手动配置 label 数据标签位置
                position: 'middle', // 'left', 'middle', 'right'
                // 可配置附加的布局方法
                layout: [
                    // 柱形图数据标签位置自动调整
                    { type: 'interval-adjust-position' },
                    // 数据标签防遮挡
                    { type: 'interval-hide-overlap' },
                    // 数据标签文颜色自动调整
                    { type: 'adjust-color' },
                ],
            },
            yAxis: {
                label: {
                    autoRotate: false,
                },
            },
            scrollbar: {
                type: 'vertical',
            },
            slider: {
                start: 0.0,
                end: 0.5,
                trendCfg: {
                    isArea: true,
                },
            },
            width: 400,
            height: 600,
            theme: {
                components: {
                    scrollbar: {
                        // 默认样式
                        default: {
                            style: {
                                trackColor: 'rgba(0,0,0,0)',
                                thumbColor: 'rgba(100,170,255,0.4)',
                            },
                        },
                        // hover 时，可以设置滑块样式
                        hover: {
                            style: {
                                thumbColor: 'rgba(100,170,255,0.8)',
                            },
                        },
                    },
                },
            },
        });
        stackedBarPlot.render();
    }

    function drawPicture3(response) {
        let arr1 = [];
        let arr2 = [];
        let respData = response.data;

        for (let i = 0, n = respData.monthLoanList.length; i < n; i++) {
            let monthLoan = respData.monthLoanList[i];
            let month = monthLoan.month + '';
            arr1.push({
                name: "当月还款",
                month: month,
                value: monthLoan.repayment,
            });
            arr1.push({
                name: "其中本金",
                month: month,
                value: monthLoan.principal,
            });
            arr1.push({
                name: "其中利息",
                month: month,
                value: monthLoan.interest,
            });
            arr2.push({
                name: "剩余本金",
                month: month,
                value: monthLoan.remainPrincipal,
            });
            arr2.push({
                name: "剩余利息",
                month: month,
                value: monthLoan.remainInterest,
            });
            arr2.push({
                name: "累计还款",
                month: month,
                value: monthLoan.totalRepayment,
            });
            arr2.push({
                name: "累计还款+剩余本金",
                month: month,
                value: monthLoan.totalRepaymentAndRemainPrincipal,
            });
        }

        const linePlot = new Line('container3', {
            data: arr1,
            padding: "auto",
            xField: 'month',
            yField: 'value',
            seriesField: 'name',
            yAxis: {
                title: {
                    text: "金额（元）",
                }
            },
            xAxis: {
                title: {
                    text: "还款期数（月）",
                },
                tickInterval: 12,
            },
            legend: {
                position: 'top',
            },
            tooltip: {
                customItems: originalItems => originalItems.sort(function (a, b) {
                    return b.value - a.value
                })
            },
            animation: {
                appear: {
                    animation: 'path-in',
                    duration: 10000,
                },
            },
        });

        const linePlot2 = new Line('container4', {
            data: arr2,
            padding: "auto",
            xField: 'month',
            yField: 'value',
            seriesField: 'name',
            yAxis: {
                title: {
                    text: "金额（元）",
                }
            },
            xAxis: {
                title: {
                    text: "还款期数（月）",
                },
                tickInterval: 12,
            },
            legend: {
                position: 'top',
            },
            tooltip: {
                customItems: originalItems => originalItems.sort(function (a, b) {
                    return b.value - a.value
                })
            },
            animation: {
                appear: {
                    animation: 'path-in',
                    duration: 10000,
                },
            },
        });

        linePlot.render();
        linePlot2.render();
    }

    // 小数补0指2位小数
    function padDecimal(num, decimal) {
        const parts = num.toString().split('.');
        if (parts.length < 2) {
            parts.push(''); // 整数需要追加小数部分
        }

        // 末尾补0
        parts[1] += '0'.repeat(decimal - parts[1].length);
        return Number(parts.join('.'));
    }

    // 校验输入的参数合法性
    function validated() {
        const amountInput = document.getElementById('amount');
        amountInput.addEventListener('input', function (e) {
            const value = e.target.value;
            if (!/^\d+$/.test(value)) {
                e.target.value = value.replace(/\D/g, '');
            }
        });
        const yearInput = document.getElementById('year');
        yearInput.addEventListener('input', function (e) {
            const value = e.target.value;
            if (!/^\d+$/.test(value)) {
                e.target.value = value.replace(/\D/g, '');
            }
        });

        const rateInput = document.getElementById('rate');

        rateInput.addEventListener('input', function(e) {
            const value = e.target.value;

            // 整数或1-2位小数的正则表达式
            const regex = /^\d+(\.\d{1,2})?$|^[1-9]\d*$/;
            if (!regex.test(value)) {
                e.target.value = value.replace(/[^\d.]/g, '');
                // 保留最多两位小数
                if (value.split('.').length > 1 && value.split('.')[1].length > 2) {
                    e.target.value = parseFloat(value).toFixed(2);
                }
            }
        });
    }

</script>
</body>