<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <title>MapVGL</title>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <style>
        html,
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map_container {
            width: 100%;
            height: 100%;
            margin: 0;
        }
    </style>
    <script src="//api.map.baidu.com/api?v=1.0&type=webgl&ak=W0I0NosnFguGL18IoQeoFubX5osIDwvW"></script>
    <script src="//mapv.baidu.com/build/mapv.min.js"></script>
    <script src="js/common.js"></script>
    <script src="https://unpkg.com/mapvgl@1.0.0-beta.168/dist/mapvgl.min.js"></script>
</head>
<body>
<div id="map_container"></div>
<script>

    var map = initMap();

    map.centerAndZoom(new BMapGL.Point(108.95352, 34.26569), 12.0);
    // map.setHeading(30);
    var view = new mapvgl.View({
        map: map
    });

    view.startAnimation();

    // fetch('./car1.csv').then(function (rs) {
    //     return rs.text();
    // }).then(function (csvstr) {
    //     var dataSet = mapv.csv.getDataSet(csvstr);
    //     var data = dataSet.get();
    //     var lineLayer = new mapvgl.LineTripLayer({
    //         step: 0.5,
    //         trailLength: 100,
    //         color: 'rgb(0, 255, 255)'
    //     });
    //     view.addLayer(lineLayer);
    //     lineLayer.setData(data);
    // });

    fetch('./car1.csv').then(function (rs) {
        return rs.text();
    }).then(function (csvstr) {
        var dataSet = mapv.csv.getDataSet(csvstr);
        var data = dataSet.get();

        // 计算所有轨迹的最大点数，用于设置合适的endTime
        var maxPoints = 0;
        for (var i = 0; i < data.length; i++) {
            if (data[i].geometry && data[i].geometry.coordinates) {
                maxPoints = Math.max(maxPoints, data[i].geometry.coordinates.length);
            }
        }

        // 为每一条轨迹线创建独立的Layer
        for (var i = 0; i < data.length; i++) {
            var lineData = [data[i]]; // 每次只取一条数据

            var lineLayer = new mapvgl.LineTripLayer({
                step: 0.5,
                trailLength: 100,
                color: getRandomColor(), // 为每条线使用不同颜色
                startTime: i * 100, // 每条线延迟100单位时间开始
                endTime: i * 100 + lineData.length // 结束时间基于起始时间和轨迹点数
            });
            view.addLayer(lineLayer);
            lineLayer.setData(lineData);
        }
    });

    // 生成随机颜色的函数
    function getRandomColor() {
        var colors = [
            'rgb(0, 255, 255)',
            'rgb(255, 0, 0)',
            'rgb(0, 255, 0)',
            'rgb(255, 255, 0)',
            'rgb(255, 0, 255)',
            'rgb(0,119,255)',
            'rgb(255,89,0)',
            'rgb(255, 0, 255)',
            'rgb(0, 0, 255)'
        ];
        return colors[Math.floor(Math.random() * colors.length)];
    }

</script>
</body>
</html>